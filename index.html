<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Kedisiplinan Siswa - SMK</title><!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"><!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script><!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"><!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script><!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script><!-- jsPDF & html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script><!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script><!-- Element SDK -->
  <script src="/_sdk/element_sdk.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'inter': ['Inter', 'sans-serif'],
          },
          colors: {
            primary: '#2563eb',
            secondary: '#64748b',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
          }
        }
      }
    }
  </script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    .sidebar {
      transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
    }
    
    .sidebar.collapsed {
      transform: translateX(-100%);
    }
    
    @media (min-width: 768px) {
      .sidebar.collapsed {
        transform: translateX(0);
        width: 70px;
      }
      
      .sidebar.collapsed .nav-text,
      .sidebar.collapsed .logo-text {
        display: none;
      }
      
      .sidebar.collapsed .nav-item {
        justify-content: center;
      }
    }
    
    .main-content {
      transition: margin-left 0.3s ease-in-out;
    }
    
    .view-section {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .view-section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card-stat {
      transition: all 0.3s ease;
    }
    
    .card-stat:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .nav-item {
      transition: all 0.2s ease;
    }
    
    .nav-item:hover {
      background: linear-gradient(90deg, #2563eb15 0%, transparent 100%);
    }
    
    .nav-item.active {
      background: linear-gradient(90deg, #2563eb20 0%, transparent 100%);
      border-left: 3px solid #2563eb;
    }
    
    .badge-poin {
      font-size: 0.7rem;
      padding: 2px 8px;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    .btn-action {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      border-radius: 0.375rem;
      transition: all 0.2s;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 40;
    }
    
    .mobile-overlay.active {
      display: block;
    }
    
    @media (max-width: 767px) {
      .sidebar {
        position: fixed;
        z-index: 50;
        height: 100%;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gray-50 font-inter"><!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
   <div class="text-center">
    <div class="spinner mx-auto mb-4"></div>
    <p class="text-gray-600 font-medium">Memuat data...</p>
   </div>
  </div><!-- Mobile Overlay -->
  <div id="mobileOverlay" class="mobile-overlay" onclick="toggleSidebar()"></div>
  <div class="flex h-full"><!-- Sidebar -->
   <aside id="sidebar" class="sidebar fixed md:relative w-64 bg-white h-full shadow-lg z-50 flex flex-col"><!-- Logo Section -->
    <div class="p-5 border-b border-gray-100">
     <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-school text-white text-lg"></i>
      </div>
      <div class="logo-text">
       <h1 class="font-bold text-gray-800 text-sm">SISTEM KEDISIPLINAN</h1>
       <p class="text-xs text-gray-500">SMK Negeri 1</p>
      </div>
     </div>
    </div><!-- Navigation -->
    <nav class="flex-1 p-4 space-y-1 overflow-y-auto"><a href="#" onclick="showView('dashboard')" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:text-blue-600" data-view="dashboard"> <i class="fas fa-chart-pie text-lg w-6 text-center"></i> <span class="nav-text font-medium">Dashboard</span> </a> <a href="#" onclick="showView('input')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:text-blue-600" data-view="input"> <i class="fas fa-plus-circle text-lg w-6 text-center"></i> <span class="nav-text font-medium">Input Pelanggaran</span> </a> <a href="#" onclick="showView('riwayat')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:text-blue-600" data-view="riwayat"> <i class="fas fa-history text-lg w-6 text-center"></i> <span class="nav-text font-medium">Riwayat Data</span> </a> <a href="#" onclick="showView('cetak')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:text-blue-600" data-view="cetak"> <i class="fas fa-print text-lg w-6 text-center"></i> <span class="nav-text font-medium">Cetak Surat</span> </a> <a href="#" onclick="showView('pengaturan')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:text-blue-600" data-view="pengaturan"> <i class="fas fa-cog text-lg w-6 text-center"></i> <span class="nav-text font-medium">Pengaturan</span> </a>
    </nav><!-- Footer Sidebar -->
    <div class="p-4 border-t border-gray-100">
     <div class="logo-text text-center text-xs text-gray-400">
      <p>© 2025 SMK Negeri 1</p>
      <p>v1.0.0</p>
     </div>
    </div>
   </aside><!-- Main Content -->
   <main id="mainContent" class="main-content flex-1 h-full overflow-y-auto"><!-- Top Header -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
     <div class="flex items-center justify-between px-4 py-3">
      <div class="flex items-center gap-3"><button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-lg transition"> <i class="fas fa-bars text-gray-600 text-lg"></i> </button>
       <h2 id="pageTitle" class="font-semibold text-gray-800 text-lg">Dashboard</h2>
      </div>
      <div class="flex items-center gap-3"><span class="hidden sm:block text-sm text-gray-500" id="currentDate"></span> <button onclick="refreshData()" class="p-2 hover:bg-gray-100 rounded-lg transition" title="Refresh Data"> <i class="fas fa-sync-alt text-gray-600"></i> </button>
      </div>
     </div>
    </header><!-- Content Container -->
    <div class="p-4 md:p-6"><!-- ==================== DASHBOARD VIEW ==================== -->
     <section id="view-dashboard" class="view-section active"><!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
       <div class="card-stat bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-sm text-gray-500 mb-1">Total Pelanggaran</p>
          <h3 id="statTotalPelanggaran" class="text-2xl font-bold text-gray-800">0</h3>
          <p class="text-xs text-gray-400 mt-1">Bulan ini</p>
         </div>
         <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center"><i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
         </div>
        </div>
       </div>
       <div class="card-stat bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-sm text-gray-500 mb-1">Siswa Bermasalah</p>
          <h3 id="statSiswaBermasalah" class="text-2xl font-bold text-gray-800">0</h3>
          <p class="text-xs text-gray-400 mt-1">Poin ≥ 50</p>
         </div>
         <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center"><i class="fas fa-user-times text-orange-500 text-xl"></i>
         </div>
        </div>
       </div>
       <div class="card-stat bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-sm text-gray-500 mb-1">Sudah Ditindak</p>
          <h3 id="statSudahDitindak" class="text-2xl font-bold text-gray-800">0</h3>
          <p class="text-xs text-gray-400 mt-1">Kasus selesai</p>
         </div>
         <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center"><i class="fas fa-check-circle text-green-500 text-xl"></i>
         </div>
        </div>
       </div>
       <div class="card-stat bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-sm text-gray-500 mb-1">Belum Ditindak</p>
          <h3 id="statBelumDitindak" class="text-2xl font-bold text-gray-800">0</h3>
          <p class="text-xs text-gray-400 mt-1">Perlu tindakan</p>
         </div>
         <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center"><i class="fas fa-clock text-blue-500 text-xl"></i>
         </div>
        </div>
       </div>
      </div><!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"><!-- Chart Pelanggaran per Kelas -->
       <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4"><i class="fas fa-chart-bar text-blue-500 mr-2"></i> Pelanggaran per Kelas</h3>
        <div class="h-64">
         <canvas id="chartPerKelas"></canvas>
        </div>
       </div><!-- Chart Jenis Pelanggaran -->
       <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4"><i class="fas fa-chart-pie text-purple-500 mr-2"></i> Jenis Pelanggaran</h3>
        <div class="h-64">
         <canvas id="chartJenisPelanggaran"></canvas>
        </div>
       </div>
      </div><!-- Recent Violations Table -->
      <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
       <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold text-gray-800"><i class="fas fa-list text-green-500 mr-2"></i> Pelanggaran Terbaru</h3><button onclick="showView('riwayat')" class="text-sm text-blue-600 hover:text-blue-800 font-medium"> Lihat Semua <i class="fas fa-arrow-right ml-1"></i> </button>
       </div>
       <div class="table-container">
        <table class="w-full text-sm">
         <thead>
          <tr class="border-b border-gray-200">
           <th class="text-left py-3 px-2 font-semibold text-gray-600">Tanggal</th>
           <th class="text-left py-3 px-2 font-semibold text-gray-600">Nama Siswa</th>
           <th class="text-left py-3 px-2 font-semibold text-gray-600">Kelas</th>
           <th class="text-left py-3 px-2 font-semibold text-gray-600">Pelanggaran</th>
           <th class="text-center py-3 px-2 font-semibold text-gray-600">Poin</th>
           <th class="text-center py-3 px-2 font-semibold text-gray-600">Status</th>
          </tr>
         </thead>
         <tbody id="recentViolationsTable"><!-- Data will be loaded here -->
         </tbody>
        </table>
       </div>
      </div>
     </section><!-- ==================== INPUT PELANGGARAN VIEW ==================== -->
     <section id="view-input" class="view-section">
      <div class="max-w-2xl mx-auto">
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 text-lg mb-6"><i class="fas fa-edit text-blue-500 mr-2"></i> Form Input Pelanggaran</h3>
        <form id="formPelanggaran" onsubmit="submitPelanggaran(event)"><!-- Tanggal -->
         <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2"> <i class="fas fa-calendar text-gray-400 mr-1"></i> Tanggal </label> <input type="date" id="inputTanggal" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
         </div><!-- Kelas -->
         <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2"> <i class="fas fa-users text-gray-400 mr-1"></i> Kelas </label> <select id="inputKelas" required onchange="loadSiswaByKelas()" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"> <option value="">-- Pilih Kelas --</option> </select>
         </div><!-- Nama Siswa -->
         <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2"> <i class="fas fa-user text-gray-400 mr-1"></i> Nama Siswa </label> <select id="inputNamaSiswa" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"> <option value="">-- Pilih Siswa --</option> </select>
         </div><!-- Jenis Pelanggaran -->
         <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2"> <i class="fas fa-exclamation-circle text-gray-400 mr-1"></i> Jenis Pelanggaran </label> <select id="inputJenisPelanggaran" required onchange="updatePoin()" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"> <option value="">-- Pilih Jenis Pelanggaran --</option> </select>
         </div><!-- Poin (Auto) -->
         <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2"> <i class="fas fa-star text-gray-400 mr-1"></i> Poin Pelanggaran </label> <input type="number" id="inputPoin" readonly class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-xl text-gray-600">
         </div><!-- Keterangan -->
         <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2"> <i class="fas fa-comment text-gray-400 mr-1"></i> Keterangan (Opsional) </label> <textarea id="inputKeterangan" rows="3" placeholder="Tambahkan keterangan jika perlu..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition resize-none"></textarea>
         </div><!-- Status Tindakan -->
         <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2"> <i class="fas fa-check-square text-gray-400 mr-1"></i> Status Tindakan </label>
          <div class="flex gap-4"><label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="statusTindakan" value="Belum Ditindak" checked class="w-4 h-4 text-blue-600 focus:ring-blue-500"> <span class="text-sm text-gray-700">Belum Ditindak</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="statusTindakan" value="Sudah Ditindak" class="w-4 h-4 text-blue-600 focus:ring-blue-500"> <span class="text-sm text-gray-700">Sudah Ditindak</span> </label>
          </div>
         </div><!-- Ditindak Oleh (Conditional) -->
         <div id="containerDitindakOleh" class="mb-6 hidden"><label class="block text-sm font-medium text-gray-700 mb-2"> <i class="fas fa-user-tie text-gray-400 mr-1"></i> Ditindak Oleh </label> <input type="text" id="inputDitindakOleh" placeholder="Nama Guru/BK" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
         </div><!-- Submit Button --> <button type="submit" id="btnSubmit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-3 px-6 rounded-xl hover:from-blue-700 hover:to-blue-800 transition shadow-lg shadow-blue-200"> <i class="fas fa-save mr-2"></i> Simpan Pelanggaran </button>
        </form>
       </div>
      </div>
     </section><!-- ==================== RIWAYAT DATA VIEW ==================== -->
     <section id="view-riwayat" class="view-section">
      <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100"><!-- Header & Actions -->
       <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
        <h3 class="font-semibold text-gray-800 text-lg"><i class="fas fa-database text-purple-500 mr-2"></i> Riwayat Pelanggaran</h3>
        <div class="flex flex-wrap gap-2"><button onclick="exportToExcel()" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-600 transition"> <i class="fas fa-file-excel mr-1"></i> Export Excel </button> <button onclick="refreshData()" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition"> <i class="fas fa-sync mr-1"></i> Refresh </button>
        </div>
       </div><!-- Filters -->
       <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div><label class="block text-xs font-medium text-gray-500 mb-1">Filter Kelas</label> <select id="filterKelas" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"> <option value="">Semua Kelas</option> </select>
        </div>
        <div><label class="block text-xs font-medium text-gray-500 mb-1">Filter Status</label> <select id="filterStatus" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"> <option value="">Semua Status</option> <option value="Sudah Ditindak">Sudah Ditindak</option> <option value="Belum Ditindak">Belum Ditindak</option> </select>
        </div>
        <div><label class="block text-xs font-medium text-gray-500 mb-1">Dari Tanggal</label> <input type="date" id="filterTanggalMulai" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
        </div>
        <div><label class="block text-xs font-medium text-gray-500 mb-1">Sampai Tanggal</label> <input type="date" id="filterTanggalAkhir" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
        </div>
       </div><!-- Search -->
       <div class="mb-4">
        <div class="relative"><input type="text" id="searchRiwayat" placeholder="Cari nama siswa..." oninput="applyFilters()" class="w-full px-4 py-3 pl-10 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"> <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        </div>
       </div><!-- Data Table -->
       <div class="table-container">
        <table class="w-full text-sm">
         <thead>
          <tr class="bg-gray-50 border-b border-gray-200">
           <th class="text-left py-3 px-3 font-semibold text-gray-600">No</th>
           <th class="text-left py-3 px-3 font-semibold text-gray-600">Tanggal</th>
           <th class="text-left py-3 px-3 font-semibold text-gray-600">Nama Siswa</th>
           <th class="text-left py-3 px-3 font-semibold text-gray-600">Kelas</th>
           <th class="text-left py-3 px-3 font-semibold text-gray-600">Pelanggaran</th>
           <th class="text-center py-3 px-3 font-semibold text-gray-600">Poin</th>
           <th class="text-center py-3 px-3 font-semibold text-gray-600">Status</th>
           <th class="text-center py-3 px-3 font-semibold text-gray-600">Aksi</th>
          </tr>
         </thead>
         <tbody id="riwayatTableBody"><!-- Data will be loaded here -->
         </tbody>
        </table>
       </div><!-- Pagination Info -->
       <div class="flex items-center justify-between mt-4 text-sm text-gray-500"><span id="riwayatInfo">Menampilkan 0 data</span>
        <div class="flex gap-2"><button id="btnPrev" onclick="prevPage()" class="px-3 py-1 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50" disabled> <i class="fas fa-chevron-left"></i> </button> <span id="pageInfo" class="px-3 py-1">1 / 1</span> <button id="btnNext" onclick="nextPage()" class="px-3 py-1 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50" disabled> <i class="fas fa-chevron-right"></i> </button>
        </div>
       </div>
      </div>
     </section><!-- ==================== CETAK SURAT VIEW ==================== -->
     <section id="view-cetak" class="view-section">
      <div class="max-w-3xl mx-auto">
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
        <h3 class="font-semibold text-gray-800 text-lg mb-6"><i class="fas fa-print text-orange-500 mr-2"></i> Cetak Surat Panggilan/Peringatan</h3><!-- Form Cetak -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label> <select id="cetakKelas" onchange="loadSiswaForCetak()" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Kelas --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Siswa</label> <select id="cetakSiswa" onchange="loadRiwayatSiswa()" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Siswa --</option> </select>
         </div>
        </div><!-- Jenis Surat -->
        <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Surat</label>
         <div class="flex flex-wrap gap-4"><label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="jenisSurat" value="panggilan" checked class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Surat Panggilan Orang Tua</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="jenisSurat" value="peringatan" class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Surat Peringatan</span> </label>
         </div>
        </div><button onclick="generateSurat()" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white font-semibold py-3 px-6 rounded-xl hover:from-orange-600 hover:to-orange-700 transition shadow-lg shadow-orange-200"> <i class="fas fa-file-pdf mr-2"></i> Generate &amp; Cetak PDF </button>
       </div><!-- Preview Surat -->
       <div id="previewSuratContainer" class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hidden">
        <h4 class="font-semibold text-gray-800 mb-4">Preview Surat</h4>
        <div id="previewSurat" class="border border-gray-200 rounded-lg p-6 bg-white"><!-- Preview content -->
        </div>
       </div>
      </div>
     </section><!-- ==================== PENGATURAN VIEW ==================== -->
     <section id="view-pengaturan" class="view-section">
      <div class="max-w-3xl mx-auto space-y-6"><!-- Data Siswa -->
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 text-lg mb-4"><i class="fas fa-user-graduate text-blue-500 mr-2"></i> Manajemen Data Siswa</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label> <select id="settingKelas" onchange="loadSiswaForSetting()" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500"> <option value="">-- Pilih Kelas --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa Baru</label> <input type="text" id="settingNamaSiswa" placeholder="Masukkan nama siswa" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
         </div>
        </div><button onclick="tambahSiswa()" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-600 transition"> <i class="fas fa-plus mr-1"></i> Tambah Siswa </button> <!-- List Siswa -->
        <div class="mt-6">
         <h4 class="font-medium text-gray-700 mb-3">Daftar Siswa:</h4>
         <div id="listSiswaSetting" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg">
          <p class="p-4 text-gray-500 text-sm text-center">Pilih kelas untuk melihat daftar siswa</p>
         </div>
        </div>
       </div><!-- Data Pelanggaran -->
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 text-lg mb-4"><i class="fas fa-gavel text-red-500 mr-2"></i> Manajemen Jenis Pelanggaran</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Pelanggaran</label> <input type="text" id="settingJenisPelanggaran" placeholder="Nama pelanggaran" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Poin</label> <input type="number" id="settingPoinPelanggaran" placeholder="Poin" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
         </div>
        </div><button onclick="tambahJenisPelanggaran()" class="bg-red-500 text-white px-6 py-2 rounded-lg font-medium hover:bg-red-600 transition"> <i class="fas fa-plus mr-1"></i> Tambah Pelanggaran </button> <!-- List Pelanggaran -->
        <div class="mt-6">
         <h4 class="font-medium text-gray-700 mb-3">Daftar Jenis Pelanggaran:</h4>
         <div id="listPelanggaranSetting" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg"><!-- Will be loaded dynamically -->
         </div>
        </div>
       </div><!-- Sinkronisasi -->
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 text-lg mb-4"><i class="fas fa-sync text-green-500 mr-2"></i> Sinkronisasi Data</h3>
        <p class="text-sm text-gray-500 mb-4">Sinkronkan data dari Google Sheets untuk memastikan data selalu terupdate.</p><button onclick="syncAllData()" class="bg-green-500 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-600 transition"> <i class="fas fa-database mr-1"></i> Sinkronkan Semua Data </button>
       </div>
      </div>
     </section>
    </div>
   </main>
  </div>
  <script>
    // ==================== GLOBAL VARIABLES ====================
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    
    // Data Kelas
    const dataKelas = [
      'X TKR A', 'X TKR B', 'X TKR C', 'X AK A', 'X AK B',
      'XI TKR A', 'XI TKR B', 'XI TKR C', 'XI AK A', 'XI AK B',
      'XII TKR A', 'XII TKR B', 'XII TKR C', 'XII AK A', 'XII AK B'
    ];
    
    // Data Siswa (Sample - akan disinkronkan dari Sheets)
    let dataSiswa = {
      'X TKR A': ['Ahmad Ridwan', 'Budi Santoso', 'Candra Wijaya', 'Deni Firmansyah', 'Eko Prasetyo'],
      'X TKR B': ['Fajar Nugroho', 'Gilang Pratama', 'Hadi Susanto', 'Irfan Hakim', 'Joko Widodo'],
      'X TKR C': ['Kevin Anggara', 'Lukman Hakim', 'Muhammad Ali', 'Nanda Putra', 'Oscar Pratama'],
      'X AK A': ['Putri Ayu', 'Qori Ramadhani', 'Rina Sari', 'Sinta Dewi', 'Tina Marlina'],
      'X AK B': ['Umi Kulsum', 'Vina Oktavia', 'Wulan Sari', 'Xena Putri', 'Yuni Astuti'],
      'XI TKR A': ['Agus Setiawan', 'Bambang Supriadi', 'Cahyo Nugroho', 'Dimas Aditya', 'Endra Wijaya'],
      'XI TKR B': ['Faisal Rahman', 'Guntur Prakoso', 'Hendri Saputra', 'Iwan Kurniawan', 'Johan Saputra'],
      'XI TKR C': ['Krisna Murti', 'Lanang Sejati', 'Mahmud Hasan', 'Naufal Rizky', 'Opik Taopik'],
      'XI AK A': ['Puspita Sari', 'Qonita Zahra', 'Ratna Sari', 'Suci Rahayu', 'Tri Wahyuni'],
      'XI AK B': ['Ulfa Mariana', 'Vera Anggraini', 'Widya Ningsih', 'Xaviera Putri', 'Yolanda Sari'],
      'XII TKR A': ['Adi Nugroho', 'Bayu Setiawan', 'Cipto Wibowo', 'Danu Prakoso', 'Edi Santoso'],
      'XII TKR B': ['Ferry Irawan', 'Galih Pratama', 'Hendra Gunawan', 'Indra Lesmana', 'Jaka Tingkir'],
      'XII TKR C': ['Karno Suwito', 'Lutfi Hakim', 'Maulana Yusuf', 'Nur Hidayat', 'Okta Vianus'],
      'XII AK A': ['Paramita Dewi', 'Quinza Aulia', 'Rosita Dewi', 'Safitri Ningsih', 'Tiara Putri'],
      'XII AK B': ['Ulfah Ramadhani', 'Vivi Andriani', 'Winda Sari', 'Xiomara Putri', 'Zahra Aulia']
    };
    
    // Data Jenis Pelanggaran (Sample)
    let dataPelanggaran = [
      { nama: 'Terlambat masuk sekolah', poin: 5 },
      { nama: 'Tidak memakai seragam lengkap', poin: 10 },
      { nama: 'Membolos', poin: 25 },
      { nama: 'Merokok di lingkungan sekolah', poin: 50 },
      { nama: 'Berkelahi', poin: 75 },
      { nama: 'Membawa HP tanpa izin', poin: 15 },
      { nama: 'Tidak mengerjakan PR', poin: 5 },
      { nama: 'Rambut panjang/diwarnai (putra)', poin: 10 },
      { nama: 'Menggunakan make-up berlebihan', poin: 10 },
      { nama: 'Berbicara kasar kepada guru', poin: 30 },
      { nama: 'Merusak fasilitas sekolah', poin: 40 },
      { nama: 'Bullying/perundungan', poin: 60 }
    ];
    
    // Riwayat Pelanggaran (Sample data)
    let riwayatPelanggaran = [
      { id: 1, tanggal: '2025-01-15', nama: 'Ahmad Ridwan', kelas: 'X TKR A', pelanggaran: 'Terlambat masuk sekolah', poin: 5, status: 'Sudah Ditindak', ditindakOleh: 'Pak Budi', keterangan: '' },
      { id: 2, tanggal: '2025-01-15', nama: 'Budi Santoso', kelas: 'X TKR A', pelanggaran: 'Tidak memakai seragam lengkap', poin: 10, status: 'Belum Ditindak', ditindakOleh: '', keterangan: '' },
      { id: 3, tanggal: '2025-01-14', nama: 'Putri Ayu', kelas: 'X AK A', pelanggaran: 'Membawa HP tanpa izin', poin: 15, status: 'Sudah Ditindak', ditindakOleh: 'Bu Sari', keterangan: 'HP disita selama 1 minggu' },
      { id: 4, tanggal: '2025-01-14', nama: 'Fajar Nugroho', kelas: 'X TKR B', pelanggaran: 'Membolos', poin: 25, status: 'Belum Ditindak', ditindakOleh: '', keterangan: '' },
      { id: 5, tanggal: '2025-01-13', nama: 'Agus Setiawan', kelas: 'XI TKR A', pelanggaran: 'Merokok di lingkungan sekolah', poin: 50, status: 'Sudah Ditindak', ditindakOleh: 'Pak BK', keterangan: 'Panggilan orang tua' }
    ];
    
    // Chart instances
    let chartPerKelas = null;
    let chartJenisPelanggaran = null;
    
    // Config for Element SDK
    const defaultConfig = {
      app_title: 'Sistem Kedisiplinan Siswa'
    };
    
    let config = { ...defaultConfig };
    
    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });
    
    /**
     * Initialize the application
     */
    function initializeApp() {
      // Set current date
      updateCurrentDate();
      
      // Set default date for input form
      document.getElementById('inputTanggal').valueAsDate = new Date();
      
      // Populate dropdowns
      populateKelasDropdowns();
      populatePelanggaranDropdown();
      
      // Load initial data
      allData = [...riwayatPelanggaran];
      filteredData = [...allData];
      
      // Initialize dashboard
      updateDashboardStats();
      initializeCharts();
      loadRecentViolations();
      
      // Load riwayat table
      renderRiwayatTable();
      
      // Load pelanggaran list in settings
      renderPelanggaranList();
      
      // Setup event listeners
      setupEventListeners();
      
      // Hide loading overlay
      setTimeout(() => {
        document.getElementById('loadingOverlay').style.display = 'none';
      }, 500);
      
      // Initialize Element SDK
      initElementSDK();
    }
    
    /**
     * Initialize Element SDK
     */
    function initElementSDK() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig: defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...config, ...newConfig };
            // Update UI based on config changes
            document.querySelector('.logo-text h1').textContent = config.app_title || defaultConfig.app_title;
          },
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title]
          ])
        });
      }
    }
    
    /**
     * Update current date display
     */
    function updateCurrentDate() {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const today = new Date().toLocaleDateString('id-ID', options);
      document.getElementById('currentDate').textContent = today;
    }
    
    /**
     * Populate all kelas dropdowns
     */
    function populateKelasDropdowns() {
      const selectors = ['#inputKelas', '#filterKelas', '#cetakKelas', '#settingKelas'];
      
      selectors.forEach(selector => {
        const select = document.querySelector(selector);
        if (select) {
          // Keep first option
          const firstOption = select.options[0];
          select.innerHTML = '';
          select.appendChild(firstOption);
          
          dataKelas.forEach(kelas => {
            const option = document.createElement('option');
            option.value = kelas;
            option.textContent = kelas;
            select.appendChild(option);
          });
        }
      });
    }
    
    /**
     * Populate pelanggaran dropdown
     */
    function populatePelanggaranDropdown() {
      const select = document.getElementById('inputJenisPelanggaran');
      if (select) {
        select.innerHTML = '<option value="">-- Pilih Jenis Pelanggaran --</option>';
        
        dataPelanggaran.forEach(item => {
          const option = document.createElement('option');
          option.value = item.nama;
          option.dataset.poin = item.poin;
          option.textContent = `${item.nama} (${item.poin} poin)`;
          select.appendChild(option);
        });
      }
    }
    
    /**
     * Setup event listeners
     */
    function setupEventListeners() {
      // Radio button for status tindakan
      document.querySelectorAll('input[name="statusTindakan"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const container = document.getElementById('containerDitindakOleh');
          if (this.value === 'Sudah Ditindak') {
            container.classList.remove('hidden');
          } else {
            container.classList.add('hidden');
          }
        });
      });
    }
    
    // ==================== NAVIGATION ====================
    
    /**
     * Toggle sidebar visibility
     */
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');
      
      sidebar.classList.toggle('collapsed');
      
      if (window.innerWidth < 768) {
        overlay.classList.toggle('active');
      }
    }
    
    /**
     * Show specific view and hide others
     * @param {string} viewName - Name of the view to show
     */
    function showView(viewName) {
      // Hide all views
      document.querySelectorAll('.view-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Show selected view
      const targetView = document.getElementById(`view-${viewName}`);
      if (targetView) {
        targetView.classList.add('active');
      }
      
      // Update navigation active state
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === viewName) {
          item.classList.add('active');
        }
      });
      
      // Update page title
      const titles = {
        'dashboard': 'Dashboard',
        'input': 'Input Pelanggaran',
        'riwayat': 'Riwayat Data',
        'cetak': 'Cetak Surat',
        'pengaturan': 'Pengaturan'
      };
      document.getElementById('pageTitle').textContent = titles[viewName] || 'Dashboard';
      
      // Close sidebar on mobile
      if (window.innerWidth < 768) {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        sidebar.classList.add('collapsed');
        overlay.classList.remove('active');
      }
      
      // Refresh data if needed
      if (viewName === 'dashboard') {
        updateDashboardStats();
        updateCharts();
        loadRecentViolations();
      }
    }
    
    // ==================== DASHBOARD FUNCTIONS ====================
    
    /**
     * Update dashboard statistics
     */
    function updateDashboardStats() {
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      
      // Filter for current month
      const thisMonthData = allData.filter(item => {
        const itemDate = new Date(item.tanggal);
        return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
      });
      
      // Total pelanggaran bulan ini
      document.getElementById('statTotalPelanggaran').textContent = thisMonthData.length;
      
      // Siswa bermasalah (poin >= 50)
      const poinPerSiswa = {};
      allData.forEach(item => {
        if (!poinPerSiswa[item.nama]) {
          poinPerSiswa[item.nama] = 0;
        }
        poinPerSiswa[item.nama] += item.poin;
      });
      const siswaBermasalah = Object.values(poinPerSiswa).filter(poin => poin >= 50).length;
      document.getElementById('statSiswaBermasalah').textContent = siswaBermasalah;
      
      // Sudah ditindak
      const sudahDitindak = allData.filter(item => item.status === 'Sudah Ditindak').length;
      document.getElementById('statSudahDitindak').textContent = sudahDitindak;
      
      // Belum ditindak
      const belumDitindak = allData.filter(item => item.status === 'Belum Ditindak').length;
      document.getElementById('statBelumDitindak').textContent = belumDitindak;
    }
    
    /**
     * Initialize charts
     */
    function initializeCharts() {
      // Chart Pelanggaran per Kelas
      const ctxKelas = document.getElementById('chartPerKelas').getContext('2d');
      
      const kelasLabels = dataKelas.slice(0, 8); // Show only first 8 classes
      const kelasData = kelasLabels.map(kelas => {
        return allData.filter(item => item.kelas === kelas).length;
      });
      
      chartPerKelas = new Chart(ctxKelas, {
        type: 'bar',
        data: {
          labels: kelasLabels,
          datasets: [{
            label: 'Jumlah Pelanggaran',
            data: kelasData,
            backgroundColor: 'rgba(37, 99, 235, 0.8)',
            borderColor: 'rgba(37, 99, 235, 1)',
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
      
      // Chart Jenis Pelanggaran
      const ctxJenis = document.getElementById('chartJenisPelanggaran').getContext('2d');
      
      const jenisCounts = {};
      allData.forEach(item => {
        if (!jenisCounts[item.pelanggaran]) {
          jenisCounts[item.pelanggaran] = 0;
        }
        jenisCounts[item.pelanggaran]++;
      });
      
      const sortedJenis = Object.entries(jenisCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      chartJenisPelanggaran = new Chart(ctxJenis, {
        type: 'doughnut',
        data: {
          labels: sortedJenis.map(item => item[0]),
          datasets: [{
            data: sortedJenis.map(item => item[1]),
            backgroundColor: [
              'rgba(239, 68, 68, 0.8)',
              'rgba(245, 158, 11, 0.8)',
              'rgba(16, 185, 129, 0.8)',
              'rgba(59, 130, 246, 0.8)',
              'rgba(139, 92, 246, 0.8)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 12,
                padding: 10,
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }
    
    /**
     * Update charts with new data
     */
    function updateCharts() {
      if (chartPerKelas && chartJenisPelanggaran) {
        // Update bar chart
        const kelasLabels = dataKelas.slice(0, 8);
        const kelasData = kelasLabels.map(kelas => {
          return allData.filter(item => item.kelas === kelas).length;
        });
        chartPerKelas.data.datasets[0].data = kelasData;
        chartPerKelas.update();
        
        // Update doughnut chart
        const jenisCounts = {};
        allData.forEach(item => {
          if (!jenisCounts[item.pelanggaran]) {
            jenisCounts[item.pelanggaran] = 0;
          }
          jenisCounts[item.pelanggaran]++;
        });
        
        const sortedJenis = Object.entries(jenisCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        
        chartJenisPelanggaran.data.labels = sortedJenis.map(item => item[0]);
        chartJenisPelanggaran.data.datasets[0].data = sortedJenis.map(item => item[1]);
        chartJenisPelanggaran.update();
      }
    }
    
    /**
     * Load recent violations for dashboard table
     */
    function loadRecentViolations() {
      const tbody = document.getElementById('recentViolationsTable');
      const recentData = [...allData].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).slice(0, 5);
      
      if (recentData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="py-8 text-center text-gray-500">
              <i class="fas fa-inbox text-4xl mb-2 text-gray-300"></i>
              <p>Belum ada data pelanggaran</p>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = recentData.map(item => `
        <tr class="border-b border-gray-100 hover:bg-gray-50">
          <td class="py-3 px-2 text-gray-600">${formatDate(item.tanggal)}</td>
          <td class="py-3 px-2 font-medium text-gray-800">${item.nama}</td>
          <td class="py-3 px-2 text-gray-600">${item.kelas}</td>
          <td class="py-3 px-2 text-gray-600">${truncateText(item.pelanggaran, 25)}</td>
          <td class="py-3 px-2 text-center">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${getPoinBadgeClass(item.poin)} text-white font-semibold text-xs">
              ${item.poin}
            </span>
          </td>
          <td class="py-3 px-2 text-center">
            <span class="badge-poin ${item.status === 'Sudah Ditindak' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} rounded-full">
              ${item.status}
            </span>
          </td>
        </tr>
      `).join('');
    }
    
    // ==================== INPUT PELANGGARAN FUNCTIONS ====================
    
    /**
     * Load siswa based on selected kelas
     */
    function loadSiswaByKelas() {
      const kelas = document.getElementById('inputKelas').value;
      const select = document.getElementById('inputNamaSiswa');
      
      select.innerHTML = '<option value="">-- Pilih Siswa --</option>';
      
      if (kelas && dataSiswa[kelas]) {
        dataSiswa[kelas].forEach(nama => {
          const option = document.createElement('option');
          option.value = nama;
          option.textContent = nama;
          select.appendChild(option);
        });
      }
    }
    
    /**
     * Update poin based on selected pelanggaran
     */
    function updatePoin() {
      const select = document.getElementById('inputJenisPelanggaran');
      const poinInput = document.getElementById('inputPoin');
      
      const selectedOption = select.options[select.selectedIndex];
      if (selectedOption && selectedOption.dataset.poin) {
        poinInput.value = selectedOption.dataset.poin;
      } else {
        poinInput.value = '';
      }
    }
    
    /**
     * Submit pelanggaran form
     * @param {Event} event - Form submit event
     */
    function submitPelanggaran(event) {
      event.preventDefault();
      
      const tanggal = document.getElementById('inputTanggal').value;
      const kelas = document.getElementById('inputKelas').value;
      const nama = document.getElementById('inputNamaSiswa').value;
      const pelanggaran = document.getElementById('inputJenisPelanggaran').value;
      const poin = parseInt(document.getElementById('inputPoin').value);
      const keterangan = document.getElementById('inputKeterangan').value;
      const status = document.querySelector('input[name="statusTindakan"]:checked').value;
      const ditindakOleh = document.getElementById('inputDitindakOleh').value;
      
      // Validation
      if (!tanggal || !kelas || !nama || !pelanggaran || !poin) {
        Swal.fire({
          icon: 'warning',
          title: 'Data Belum Lengkap',
          text: 'Mohon lengkapi semua field yang wajib diisi',
          confirmButtonColor: '#2563eb'
        });
        return;
      }
      
      // Konfirmasi sebelum menyimpan
      Swal.fire({
        title: 'Konfirmasi Simpan',
        html: `
          <div class="text-left text-sm">
            <p><strong>Nama:</strong> ${nama}</p>
            <p><strong>Kelas:</strong> ${kelas}</p>
            <p><strong>Pelanggaran:</strong> ${pelanggaran}</p>
            <p><strong>Poin:</strong> ${poin}</p>
            <p><strong>Status:</strong> ${status}</p>
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#2563eb',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Ya, Simpan',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          // Create new record
          const newRecord = {
            id: Date.now(),
            tanggal: tanggal,
            nama: nama,
            kelas: kelas,
            pelanggaran: pelanggaran,
            poin: poin,
            status: status,
            ditindakOleh: status === 'Sudah Ditindak' ? ditindakOleh : '',
            keterangan: keterangan
          };
          
          // Add to data
          allData.unshift(newRecord);
          riwayatPelanggaran.unshift(newRecord);
          filteredData = [...allData];
          
          // Reset form
          document.getElementById('formPelanggaran').reset();
          document.getElementById('inputTanggal').valueAsDate = new Date();
          document.getElementById('containerDitindakOleh').classList.add('hidden');
          
          // Update UI
          updateDashboardStats();
          updateCharts();
          loadRecentViolations();
          renderRiwayatTable();
          
          Swal.fire({
            icon: 'success',
            title: 'Berhasil!',
            text: 'Data pelanggaran berhasil disimpan',
            confirmButtonColor: '#2563eb'
          });
        }
      });
    }
    
    // ==================== RIWAYAT DATA FUNCTIONS ====================
    
    /**
     * Apply filters to riwayat data
     */
    function applyFilters() {
      const filterKelas = document.getElementById('filterKelas').value;
      const filterStatus = document.getElementById('filterStatus').value;
      const filterTanggalMulai = document.getElementById('filterTanggalMulai').value;
      const filterTanggalAkhir = document.getElementById('filterTanggalAkhir').value;
      const searchQuery = document.getElementById('searchRiwayat').value.toLowerCase();
      
      filteredData = allData.filter(item => {
        let match = true;
        
        if (filterKelas && item.kelas !== filterKelas) match = false;
        if (filterStatus && item.status !== filterStatus) match = false;
        if (filterTanggalMulai && item.tanggal < filterTanggalMulai) match = false;
        if (filterTanggalAkhir && item.tanggal > filterTanggalAkhir) match = false;
        if (searchQuery && !item.nama.toLowerCase().includes(searchQuery)) match = false;
        
        return match;
      });
      
      currentPage = 1;
      renderRiwayatTable();
    }
    
    /**
     * Render riwayat table with pagination
     */
    function renderRiwayatTable() {
      const tbody = document.getElementById('riwayatTableBody');
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageData = filteredData.slice(startIndex, endIndex);
      
      if (pageData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="py-8 text-center text-gray-500">
              <i class="fas fa-search text-4xl mb-2 text-gray-300"></i>
              <p>Tidak ada data yang ditemukan</p>
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = pageData.map((item, index) => `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="py-3 px-3 text-gray-500">${startIndex + index + 1}</td>
            <td class="py-3 px-3 text-gray-600">${formatDate(item.tanggal)}</td>
            <td class="py-3 px-3 font-medium text-gray-800">${item.nama}</td>
            <td class="py-3 px-3 text-gray-600">${item.kelas}</td>
            <td class="py-3 px-3 text-gray-600">${truncateText(item.pelanggaran, 20)}</td>
            <td class="py-3 px-3 text-center">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${getPoinBadgeClass(item.poin)} text-white font-semibold text-xs">
                ${item.poin}
              </span>
            </td>
            <td class="py-3 px-3 text-center">
              <span class="badge-poin ${item.status === 'Sudah Ditindak' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} rounded-full">
                ${item.status}
              </span>
            </td>
            <td class="py-3 px-3 text-center">
              <div class="flex items-center justify-center gap-1">
                <button onclick="editPelanggaran(${item.id})" class="btn-action bg-blue-100 text-blue-600 hover:bg-blue-200" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deletePelanggaran(${item.id})" class="btn-action bg-red-100 text-red-600 hover:bg-red-200" title="Hapus">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }
      
      // Update pagination info
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      document.getElementById('riwayatInfo').textContent = `Menampilkan ${filteredData.length} data`;
      document.getElementById('pageInfo').textContent = `${currentPage} / ${Math.max(totalPages, 1)}`;
      
      // Update button states
      document.getElementById('btnPrev').disabled = currentPage <= 1;
      document.getElementById('btnNext').disabled = currentPage >= totalPages;
    }
    
    /**
     * Go to previous page
     */
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderRiwayatTable();
      }
    }
    
    /**
     * Go to next page
     */
    function nextPage() {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderRiwayatTable();
      }
    }
    
    /**
     * Edit pelanggaran record
     * @param {number} id - Record ID
     */
    function editPelanggaran(id) {
      const record = allData.find(item => item.id === id);
      if (!record) return;
      
      Swal.fire({
        title: 'Edit Status Tindakan',
        html: `
          <div class="text-left">
            <p class="mb-4 text-sm text-gray-600">
              <strong>${record.nama}</strong> - ${record.pelanggaran}
            </p>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
              <select id="editStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="Belum Ditindak" ${record.status === 'Belum Ditindak' ? 'selected' : ''}>Belum Ditindak</option>
                <option value="Sudah Ditindak" ${record.status === 'Sudah Ditindak' ? 'selected' : ''}>Sudah Ditindak</option>
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Ditindak Oleh</label>
              <input type="text" id="editDitindakOleh" value="${record.ditindakOleh || ''}" 
                class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nama Guru/BK">
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonColor: '#2563eb',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Simpan',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          const newStatus = document.getElementById('editStatus').value;
          const newDitindakOleh = document.getElementById('editDitindakOleh').value;
          
          // Update record
          record.status = newStatus;
          record.ditindakOleh = newStatus === 'Sudah Ditindak' ? newDitindakOleh : '';
          
          // Update UI
          updateDashboardStats();
          loadRecentViolations();
          renderRiwayatTable();
          
          Swal.fire({
            icon: 'success',
            title: 'Berhasil!',
            text: 'Data berhasil diperbarui',
            confirmButtonColor: '#2563eb'
          });
        }
      });
    }
    
    /**
     * Delete pelanggaran record
     * @param {number} id - Record ID
     */
    function deletePelanggaran(id) {
      Swal.fire({
        title: 'Hapus Data?',
        text: 'Data yang dihapus tidak dapat dikembalikan',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Ya, Hapus',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          // Remove from arrays
          allData = allData.filter(item => item.id !== id);
          riwayatPelanggaran = riwayatPelanggaran.filter(item => item.id !== id);
          filteredData = filteredData.filter(item => item.id !== id);
          
          // Update UI
          updateDashboardStats();
          updateCharts();
          loadRecentViolations();
          renderRiwayatTable();
          
          Swal.fire({
            icon: 'success',
            title: 'Terhapus!',
            text: 'Data berhasil dihapus',
            confirmButtonColor: '#2563eb'
          });
        }
      });
    }
    
    // ==================== EXPORT FUNCTIONS ====================
    
    /**
     * Export data to Excel
     */
    function exportToExcel() {
      if (filteredData.length === 0) {
        Swal.fire({
          icon: 'warning',
          title: 'Tidak Ada Data',
          text: 'Tidak ada data untuk diekspor',
          confirmButtonColor: '#2563eb'
        });
        return;
      }
      
      // Prepare data for export
      const exportData = filteredData.map((item, index) => ({
        'No': index + 1,
        'Tanggal': formatDate(item.tanggal),
        'Nama Siswa': item.nama,
        'Kelas': item.kelas,
        'Jenis Pelanggaran': item.pelanggaran,
        'Poin': item.poin,
        'Status': item.status,
        'Ditindak Oleh': item.ditindakOleh || '-',
        'Keterangan': item.keterangan || '-'
      }));
      
      // Create workbook
      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Data Pelanggaran');
      
      // Generate filename
      const today = new Date().toISOString().split('T')[0];
      const filename = `Data_Pelanggaran_Siswa_${today}.xlsx`;
      
      // Download
      XLSX.writeFile(wb, filename);
      
      Swal.fire({
        icon: 'success',
        title: 'Export Berhasil!',
        text: 'File Excel berhasil diunduh',
        confirmButtonColor: '#2563eb'
      });
    }
    
    // ==================== CETAK SURAT FUNCTIONS ====================
    
    /**
     * Load siswa for cetak surat
     */
    function loadSiswaForCetak() {
      const kelas = document.getElementById('cetakKelas').value;
      const select = document.getElementById('cetakSiswa');
      
      select.innerHTML = '<option value="">-- Pilih Siswa --</option>';
      
      if (kelas && dataSiswa[kelas]) {
        dataSiswa[kelas].forEach(nama => {
          const option = document.createElement('option');
          option.value = nama;
          option.textContent = nama;
          select.appendChild(option);
        });
      }
    }
    
    /**
     * Load riwayat siswa untuk preview
     */
    function loadRiwayatSiswa() {
      const nama = document.getElementById('cetakSiswa').value;
      const previewContainer = document.getElementById('previewSuratContainer');
      
      if (!nama) {
        previewContainer.classList.add('hidden');
        return;
      }
      
      const siswaData = allData.filter(item => item.nama === nama);
      const totalPoin = siswaData.reduce((sum, item) => sum + item.poin, 0);
      
      previewContainer.classList.remove('hidden');
      document.getElementById('previewSurat').innerHTML = `
        <div class="text-sm">
          <h4 class="font-semibold mb-2">Ringkasan Pelanggaran: ${nama}</h4>
          <p class="mb-1">Total Pelanggaran: ${siswaData.length} kali</p>
          <p class="mb-3">Total Poin: <span class="font-bold text-red-600">${totalPoin}</span></p>
          <hr class="my-3">
          <h5 class="font-medium mb-2">Rincian:</h5>
          <ul class="space-y-1">
            ${siswaData.map(item => `
              <li class="flex justify-between">
                <span>${formatDate(item.tanggal)} - ${item.pelanggaran}</span>
                <span class="font-medium">${item.poin} poin</span>
              </li>
            `).join('')}
          </ul>
        </div>
      `;
    }
    
    /**
     * Generate surat PDF
     */
    function generateSurat() {
      const kelas = document.getElementById('cetakKelas').value;
      const nama = document.getElementById('cetakSiswa').value;
      const jenisSurat = document.querySelector('input[name="jenisSurat"]:checked').value;
      
      if (!kelas || !nama) {
        Swal.fire({
          icon: 'warning',
          title: 'Data Belum Lengkap',
          text: 'Pilih kelas dan siswa terlebih dahulu',
          confirmButtonColor: '#2563eb'
        });
        return;
      }
      
      const siswaData = allData.filter(item => item.nama === nama);
      const totalPoin = siswaData.reduce((sum, item) => sum + item.poin, 0);
      
      // Create PDF using jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Header
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('SMK NEGERI 1', 105, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setFont('helvetica', 'normal');
      doc.text('Jl. Pendidikan No. 123, Kota', 105, 28, { align: 'center' });
      
      doc.line(20, 35, 190, 35);
      
      // Title
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      const title = jenisSurat === 'panggilan' ? 'SURAT PANGGILAN ORANG TUA' : 'SURAT PERINGATAN';
      doc.text(title, 105, 50, { align: 'center' });
      
      // Number
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      const nomorSurat = `No: ${Math.floor(Math.random() * 1000)}/BK/SMK/${new Date().getFullYear()}`;
      doc.text(nomorSurat, 105, 58, { align: 'center' });
      
      // Content
      doc.setFontSize(11);
      const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
      
      let yPos = 75;
      doc.text(`Kepada Yth.`, 20, yPos);
      yPos += 7;
      doc.text(`Orang Tua/Wali dari:`, 20, yPos);
      yPos += 10;
      
      doc.text(`Nama    : ${nama}`, 25, yPos);
      yPos += 7;
      doc.text(`Kelas   : ${kelas}`, 25, yPos);
      yPos += 15;
      
      if (jenisSurat === 'panggilan') {
        doc.text(`Dengan hormat,`, 20, yPos);
        yPos += 7;
        const text1 = `Bersama surat ini kami sampaikan bahwa putra/putri Bapak/Ibu telah melakukan pelanggaran`;
        doc.text(text1, 20, yPos);
        yPos += 7;
        const text2 = `tata tertib sekolah dengan total ${totalPoin} poin. Untuk itu kami mengharapkan kehadiran`;
        doc.text(text2, 20, yPos);
        yPos += 7;
        doc.text(`Bapak/Ibu di sekolah untuk membicarakan hal ini lebih lanjut.`, 20, yPos);
      } else {
        doc.text(`Dengan hormat,`, 20, yPos);
        yPos += 7;
        const text1 = `Melalui surat ini kami memberikan PERINGATAN kepada siswa tersebut di atas karena telah`;
        doc.text(text1, 20, yPos);
        yPos += 7;
        const text2 = `melakukan pelanggaran tata tertib sekolah dengan total ${totalPoin} poin.`;
        doc.text(text2, 20, yPos);
      }
      
      yPos += 20;
      doc.text(`Rincian Pelanggaran:`, 20, yPos);
      yPos += 10;
      
      siswaData.slice(0, 5).forEach((item, index) => {
        doc.text(`${index + 1}. ${item.pelanggaran} (${item.poin} poin) - ${formatDate(item.tanggal)}`, 25, yPos);
        yPos += 7;
      });
      
      if (siswaData.length > 5) {
        doc.text(`... dan ${siswaData.length - 5} pelanggaran lainnya`, 25, yPos);
        yPos += 7;
      }
      
      // Footer
      yPos += 20;
      doc.text(`Demikian surat ini kami sampaikan, atas perhatian dan kerjasamanya kami ucapkan terima kasih.`, 20, yPos);
      
      yPos += 25;
      doc.text(`${today}`, 140, yPos);
      yPos += 7;
      doc.text(`Koordinator BK`, 140, yPos);
      yPos += 25;
      doc.text(`_____________________`, 140, yPos);
      
      // Save PDF
      const filename = `Surat_${jenisSurat === 'panggilan' ? 'Panggilan' : 'Peringatan'}_${nama.replace(/\s+/g, '_')}.pdf`;
      doc.save(filename);
      
      Swal.fire({
        icon: 'success',
        title: 'Surat Berhasil Dibuat!',
        text: 'File PDF berhasil diunduh',
        confirmButtonColor: '#2563eb'
      });
    }
    
    // ==================== PENGATURAN FUNCTIONS ====================
    
    /**
     * Load siswa for setting
     */
    function loadSiswaForSetting() {
      const kelas = document.getElementById('settingKelas').value;
      const container = document.getElementById('listSiswaSetting');
      
      if (!kelas) {
        container.innerHTML = '<p class="p-4 text-gray-500 text-sm text-center">Pilih kelas untuk melihat daftar siswa</p>';
        return;
      }
      
      if (!dataSiswa[kelas] || dataSiswa[kelas].length === 0) {
        container.innerHTML = '<p class="p-4 text-gray-500 text-sm text-center">Belum ada siswa di kelas ini</p>';
        return;
      }
      
      container.innerHTML = dataSiswa[kelas].map((nama, index) => `
        <div class="flex items-center justify-between p-3 border-b border-gray-100 hover:bg-gray-50">
          <span class="text-sm">${index + 1}. ${nama}</span>
          <button onclick="hapusSiswa('${kelas}', '${nama}')" class="text-red-500 hover:text-red-700 text-sm">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join('');
    }
    
    /**
     * Tambah siswa baru
     */
    function tambahSiswa() {
      const kelas = document.getElementById('settingKelas').value;
      const nama = document.getElementById('settingNamaSiswa').value.trim();
      
      if (!kelas || !nama) {
        Swal.fire({
          icon: 'warning',
          title: 'Data Belum Lengkap',
          text: 'Pilih kelas dan masukkan nama siswa',
          confirmButtonColor: '#2563eb'
        });
        return;
      }
      
      if (!dataSiswa[kelas]) {
        dataSiswa[kelas] = [];
      }
      
      if (dataSiswa[kelas].includes(nama)) {
        Swal.fire({
          icon: 'warning',
          title: 'Sudah Ada',
          text: 'Siswa dengan nama tersebut sudah ada di kelas ini',
          confirmButtonColor: '#2563eb'
        });
        return;
      }
      
      dataSiswa[kelas].push(nama);
      document.getElementById('settingNamaSiswa').value = '';
      loadSiswaForSetting();
      
      Swal.fire({
        icon: 'success',
        title: 'Berhasil!',
        text: 'Siswa berhasil ditambahkan',
        confirmButtonColor: '#2563eb',
        timer: 1500,
        showConfirmButton: false
      });
    }
    
    /**
     * Hapus siswa
     * @param {string} kelas - Kelas siswa
     * @param {string} nama - Nama siswa
     */
    function hapusSiswa(kelas, nama) {
      Swal.fire({
        title: 'Hapus Siswa?',
        text: `Hapus ${nama} dari ${kelas}?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Ya, Hapus',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          dataSiswa[kelas] = dataSiswa[kelas].filter(n => n !== nama);
          loadSiswaForSetting();
          
          Swal.fire({
            icon: 'success',
            title: 'Terhapus!',
            text: 'Siswa berhasil dihapus',
            confirmButtonColor: '#2563eb',
            timer: 1500,
            showConfirmButton: false
          });
        }
      });
    }
    
    /**
     * Render pelanggaran list in settings
     */
    function renderPelanggaranList() {
      const container = document.getElementById('listPelanggaranSetting');
      
      if (dataPelanggaran.length === 0) {
        container.innerHTML = '<p class="p-4 text-gray-500 text-sm text-center">Belum ada jenis pelanggaran</p>';
        return;
      }
      
      container.innerHTML = dataPelanggaran.map((item, index) => `
        <div class="flex items-center justify-between p-3 border-b border-gray-100 hover:bg-gray-50">
          <div>
            <span class="text-sm">${index + 1}. ${item.nama}</span>
            <span class="ml-2 inline-flex items-center justify-center px-2 py-0.5 rounded-full text-xs font-medium ${getPoinBadgeClass(item.poin)} text-white">
              ${item.poin} poin
            </span>
          </div>
          <button onclick="hapusJenisPelanggaran(${index})" class="text-red-500 hover:text-red-700 text-sm">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join('');
    }
    
    /**
     * Tambah jenis pelanggaran baru
     */
    function tambahJenisPelanggaran() {
      const nama = document.getElementById('settingJenisPelanggaran').value.trim();
      const poin = parseInt(document.getElementById('settingPoinPelanggaran').value);
      
      if (!nama || !poin || poin <= 0) {
        Swal.fire({
          icon: 'warning',
          title: 'Data Belum Lengkap',
          text: 'Masukkan nama pelanggaran dan poin yang valid',
          confirmButtonColor: '#2563eb'
        });
        return;
      }
      
      const exists = dataPelanggaran.some(item => item.nama.toLowerCase() === nama.toLowerCase());
      if (exists) {
        Swal.fire({
          icon: 'warning',
          title: 'Sudah Ada',
          text: 'Jenis pelanggaran tersebut sudah ada',
          confirmButtonColor: '#2563eb'
        });
        return;
      }
      
      dataPelanggaran.push({ nama, poin });
      document.getElementById('settingJenisPelanggaran').value = '';
      document.getElementById('settingPoinPelanggaran').value = '';
      
      renderPelanggaranList();
      populatePelanggaranDropdown();
      
      Swal.fire({
        icon: 'success',
        title: 'Berhasil!',
        text: 'Jenis pelanggaran berhasil ditambahkan',
        confirmButtonColor: '#2563eb',
        timer: 1500,
        showConfirmButton: false
      });
    }
    
    /**
     * Hapus jenis pelanggaran
     * @param {number} index - Index pelanggaran
     */
    function hapusJenisPelanggaran(index) {
      const item = dataPelanggaran[index];
      
      Swal.fire({
        title: 'Hapus Jenis Pelanggaran?',
        text: `Hapus "${item.nama}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Ya, Hapus',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          dataPelanggaran.splice(index, 1);
          renderPelanggaranList();
          populatePelanggaranDropdown();
          
          Swal.fire({
            icon: 'success',
            title: 'Terhapus!',
            text: 'Jenis pelanggaran berhasil dihapus',
            confirmButtonColor: '#2563eb',
            timer: 1500,
            showConfirmButton: false
          });
        }
      });
    }
    
    /**
     * Sync all data
     */
    function syncAllData() {
      Swal.fire({
        title: 'Sinkronisasi Data',
        text: 'Memuat data dari server...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      // Simulate sync delay
      setTimeout(() => {
        Swal.fire({
          icon: 'success',
          title: 'Sinkronisasi Berhasil!',
          text: 'Semua data telah diperbarui',
          confirmButtonColor: '#2563eb'
        });
      }, 1500);
    }
    
    /**
     * Refresh all data
     */
    function refreshData() {
      document.getElementById('loadingOverlay').style.display = 'flex';
      
      setTimeout(() => {
        filteredData = [...allData];
        updateDashboardStats();
        updateCharts();
        loadRecentViolations();
        renderRiwayatTable();
        
        document.getElementById('loadingOverlay').style.display = 'none';
        
        Swal.fire({
          icon: 'success',
          title: 'Data Diperbarui!',
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 2000
        });
      }, 500);
    }
    
    // ==================== UTILITY FUNCTIONS ====================
    
    /**
     * Format date to Indonesian locale
     * @param {string} dateStr - Date string
     * @returns {string} Formatted date
     */
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
    }
    
    /**
     * Truncate text to specified length
     * @param {string} text - Text to truncate
     * @param {number} maxLength - Maximum length
     * @returns {string} Truncated text
     */
    function truncateText(text, maxLength) {
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }
    
    /**
     * Get badge class based on poin value
     * @param {number} poin - Poin value
     * @returns {string} CSS class
     */
    function getPoinBadgeClass(poin) {
      if (poin >= 50) return 'bg-red-500';
      if (poin >= 25) return 'bg-orange-500';
      if (poin >= 10) return 'bg-yellow-500';
      return 'bg-blue-500';
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ca8111dc25ffe08',t:'MTc3MDUyMTYyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>